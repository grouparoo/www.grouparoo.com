---
title: "Plugins"
date: "2020-01-05"
section: "development"
pullQuote: "The Grouparoo Plugin System is how you can add & extend Grouparoo."
---

The Grouparoo Plugin System is how you can add & extend Grouparoo!

## Installing a Plugin

In your Grouparoo deployment project, simply install the plugin with NPM:

1. `npm install @grouparoo/awesome-plugin`
2. Add the plugin to your `grouparoo/plugins` hash within your package.json. When complete, your `package.json` using `@grouparoo/awesome-plugin` will look like:

```json
{
  "author": "Grouparoo Inc <hello@grouparoo.com>",
  "name": "@grouparoo/example-app",
  "description": "A Grouparoo Example Application",
  "version": "0.1.0",
  "license": "UNLICENSED",
  "private": true,
  "dependencies": {
    "@grouparoo/core": "latest",
    "@grouparoo/awesome-plugin": "latest"
  },
  "scripts": {
    "prepare": "cd node_modules/@grouparoo/core && npm run prepare",
    "import": "cd node_modules/@grouparoo/core && ./api/bin/import",
    "start": "cd node_modules/@grouparoo/core && ./api/bin/start",
    "dev": "cd node_modules/@grouparoo/core && ./api/bin/dev"
  },
  "grouparoo": {
    "plugins": ["@grouparoo/awesome-plugin"]
  }
}
```

## Developing a Plugin

Plugins can:

- Add new initializers and middleware
- Add API actions
- Add new API tasks/background jobs
- Interact with the database (via `models`)
- Add new CLI commands for the API
- Create new UI pages for the Grouparoo Website

### Setup

A Grouparoo Plugin is based on the Actionhero Plugin model (https://docs.actionherojs.com/tutorial-plugins.html), and we have many hooks provided via `package.json` elements which you can use in your plugin.

Your directory structure for your plugin should look like:

```shell
/
| / src
  | - actions
  | - tasks
  | - initializers
  | - cli
  | - components
|
| - package.json
| - ts.config.json
```

The best way to develop you plugin is to create a parent Grouparoo project's `package.json` (see "Installing a Plugin" above) which requires both grouparoo-core and your new plugin. From there, you can either mount your local plugin as you develop it with tools like [`npm link`](https://docs.npmjs.com/cli/link.html) or [`lerna`](https://github.com/lerna/lerna) for more complex projects.

Below, we will enumerate the types of things your plugins can do:

- `package.json` options
- Initializers
- Grouparoo Apps & Connections
- Actions & Routes
- Define and use Settings
- Tasks
- UI Elements

### `package.json` options

In your plugin's `package.json`, we use a `grouparoo` section to list certain options:

```json
{
  "name": "@grouparoo/awesome-plugin",
  "description": "a Grouparoo plugin",
  "version": "1.0.0",
  "license": "UNLICENSED",
  "private": true,
  "engines": {
    "node": ">=12.0.0"
  },
  "scripts": {
    "prepare": "rm -rf dist && tsc --declaration",
    "test": "jest",
    "pretest": "npm run lint && npm run prepare",
    "lint": "prettier --check src/**/*.ts __tests__/**/*.ts"
  },
  "dependencies": {
    "something": "^5.10.0"
  },
  "peerDependencies": {
    "@grouparoo/core": "1.0.0",
    "actionhero": "^22.0.5"
  },
  "devDependencies": {
    "@grouparoo/core": "1.0.0",
    "actionhero": "^22.0.5",
    "@types/jest": "^25.1.4",
    "@types/node": "^13.9.0",
    "jest": "^25.1.0",
    "prettier": "^1.19.1",
    "ts-jest": "^25.2.1",
    "typescript": "^3.8.3"
  },
  "grouparoo": {
    "env": {
      "api": ["APP_API_KEY"],
      "web": ["APP_CLIENT_ID"]
    }
  }
}
```

**`grouparoo/env`**

- This section contains 2 sub-keys, `api` and `web`. The items you add to these arrays define required environment variables that your application needs to launch.
  - If these environment variables are not present, the Grouparoo Core application will display an error, but will still launch
- Environment variables uses in `grouparoo/env/api` will only be used on the api server, however `grouparoo/env/web` will be sent to the client website. Do not include secrets that should not be shared with all users in `grouparoo/env/web`.
- This example means that `process.env.APP_API_KEY` will be used by the server and `process.env.APP_CLIENT_ID` will be consumed by the web UI, and available to browsers.

**`grouparoo/serverInjection`**

- This array of files will be required very early on in the server boot process (before actionhero and config).
- This is a great place to load a bog tracker or process monitor early on in the server's life cycle
- This file needs to export a default (non-async) function which will then be run at boot.

Notes:

- Ensure that the version of Grouparoo you are targeting is in _both_ `peerDependencies` and `devDependencies`. It should not be in `dependencies`.
- If you are creating initializers, actions, or tasks, `actionhero` should be in _both_ `peerDependencies` and `devDependencies`. It should not be in `dependencies`.

### Connections

Your plugin can provide multiple types of `Apps` for use within Grouparoo. Grouparoo users can create multiple instances of each type of app. It can then create `Connections` to import and/or export data.

More information is available for each type:

- Import via [sources](./sources)
- Export via [destinations](./destinations)

### Initializers

An initializer is an Actionhero file which lives in `/src/initializers`. There are 3 lifecycle parts of an initializer: initialize, start, and stop in which you can run code.

Learn more about Actionhero initializers [here](https://www.actionherojs.com/tutorials/initializers).

Within initializers, you can register routes and create apps and connections for Grouparoo.
If your Plugin is providing apps or connections you can use the `plugin.registerPlugin` method. See the example below.

```ts
import { Initializer } from "actionhero";
import { plugin } from "@grouparoo/core";

import { test } from "./../lib/test";
import { columns } from "./../lib/columns";
import {
  profilePropertyRuleQueryOptions,
  buildProfilePropertyRuleQuery,
} from "./../lib/buildProfileQuery";
import { profiles } from "./../lib/profiles";
import { profileProperty } from "./../lib/profileProperty";
import { exportProfile } from "./../lib/exportProfile";

const packageJSON = require("./../../package.json");

export class Plugins extends Initializer {
  constructor() {
    super();
    this.name = packageJSON.name;
  }

  async initialize() {
    plugin.registerPlugin({
      name: "@grouparoo/postgres",
      icon: "/public/@grouparoo/postgres/postgres.svg",
      apps: [
        {
          name: "postgres",
          options: [
            { key: "host", required: false, description: "the postgres host" },
            { key: "port", required: false, description: "the postgres port" },
          ],
          test: test,
          profilePropertyRuleQueryOptions,
          buildProfilePropertyRuleQuery,
        },
      ],
      connections: [
        {
          name: "postgres-import",
          direction: "import",
          description: "import or update profiles from a postgres database",
          app: ["postgres"],
          options: [
            { key: "table", required: true, description: "the table to scan" },
          ],
          methods: {
            profiles,
            profileProperty,
            columns,
          },
        },
        {
          name: "postgres-export",
          direction: "export",
          description: "export profiles to a postgres table",
          app: ["postgres"],
          options: [
            {
              key: "table",
              required: true,
              description: "the table to write profiles to",
            },
          ],
          methods: {
            exportProfile,
            columns,
          },
        },
      ],
    });
  }
}
```

### Actions

Actions are how you can add API endpoints to Grouparoo!

To learn more about actions, visit https://www.actionherojs.com/tutorials/actions

You likely want to authenticate your actions. You can use Grouparoo's middleware for this:

```js
const { Action } = require("actionhero");

exports.action = class AwesomeStatus extends Action {
  constructor() {
    super();
    this.name = "awesome:getStatus";
    this.description = "I let you know how awesome you are";
    this.inputs = {};
    this.middleware = ["authenticated-action"]; // <-- here

    // define the permissions needed to use this action
    this.permission = { topic: "profile", mode: "read" };
  }

  async run({ response }) {
    response.awesome = true;
  }
};
```

If you want your action to require a logged-in web user or valid API Key, use the `authenticated-action` middleware. We will then check that this user/API Key has the proper permissions you specified.

Unlike actions directly provided by Grouparoo Core, Actions created by plugins will need to be manually added to the roues file. You do this in an initializer within your plugin:

```ts
import { Initializer, route } from "actionhero";

export class MySignIn extends Initializer {
  constructor() {
    super();
    this.name = "myPlugin:authentication";
  }

  async initialize() {
    route.registerRoute(
      "post", // The HTTP Verb
      "/v:apiVersion/session/myApp", // The Route (with variables)
      "session:myApp:create" // the name of the action
    );
  }
}
```

### Tasks

Actions are how you can add background jobs to Grouparoo!

To learn more about tasks, visit https://www.actionherojs.com/tutorials/tasks

### Settings

You can define user-configurable settings for your plugins. These will be exposed to the Grouparoo Administrators in the "settings" menu. Settings are defined within an initializer.

```js
// Define a setting for your plugin
await api.plugins.registerSetting(pluginName, key, defaultValue, description);

// Read a setting
const { key, value, description, defaultValue } = await api.plugins.readSetting(
  pluginName,
  key
);

// Update a setting
await api.plugins.updateSetting(pluginName, key, value);
```

Settings are all of type `string`, so coerce them if needed. Setting keys and values are limited to 191 characters in length.
